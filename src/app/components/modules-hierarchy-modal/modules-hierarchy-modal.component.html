<div class="mh-overlay">
  <div class="mh-modal">
    <div class="mh-head">
      <div class="title-group">
        <div class="icon-wrapper">
          <iconify-icon icon="lucide:layout-tree"></iconify-icon>
        </div>
        <div class="text-wrapper">
          <h3>{{ titulo }}</h3>
          <p>Organiza la estructura de navegación</p>
        </div>
      </div>
      <button class="btn-close" (click)="cerrar()" title="Cerrar">
        <iconify-icon icon="lucide:x"></iconify-icon>
      </button>
    </div>

    <div class="mh-toolbar">
      <button class="btn btn-primary btn-sm" (click)="addChild()">
        <iconify-icon icon="lucide:plus-circle"></iconify-icon>
        <span>Nuevo Módulo Raíz</span>
      </button>
    </div>

    <div *ngIf="error" class="mh-error">
      <iconify-icon icon="lucide:alert-circle"></iconify-icon>
      <span>{{ error }}</span>
    </div>

    <div class="mh-body" *ngIf="!loading && !error">
      <ul class="tree-container">
        <ng-container *ngFor="let n of tree; trackBy: trackById">
          <ng-container *ngTemplateOutlet="nodeItemTpl; context: {$implicit: n}"></ng-container>
        </ng-container>
      </ul>
    </div>

    <div class="mh-foot">
      <button class="btn btn-ghost" (click)="cerrar()">Cancelar</button>
      <button class="btn btn-primary shadow-sm" (click)="cerrar()">Guardar Cambios</button>
    </div>
  </div>
</div>

<ng-template #nodeItemTpl let-node>
  <li class="tree-item">
    <input *ngIf="node.children?.length" class="tgl-input" type="checkbox" [attr.id]="'t'+node.id_modulo" checked />
    
    <div class="node-row" [class.is-inactive]="node.estado == '0'">
      <div class="node-main">
        <label *ngIf="node.children?.length" class="caret-custom" [attr.for]="'t'+node.id_modulo">
          <iconify-icon icon="lucide:chevron-right" class="caret-icon"></iconify-icon>
        </label>
        <div *ngIf="!node.children?.length" class="caret-spacer">
           <div class="dot-spacer"></div>
        </div>

        <iconify-icon [icon]="node.estado == '0' ? 'lucide:eye-off' : (node.children?.length ? 'lucide:folder' : 'lucide:file-code')" 
                      class="type-icon"></iconify-icon>

        <div class="node-content">
          <span class="node-name">{{ node.nombre }}</span>
          <span class="node-url" *ngIf="node.url">{{ node.url }}</span>
        </div>
      </div>

      <div class="node-actions">
        <button class="action-btn add" (click)="addChild(node)" title="Añadir"><iconify-icon icon="lucide:plus"></iconify-icon></button>
        <button class="action-btn edit" (click)="editNode(node)" title="Editar"><iconify-icon icon="lucide:edit-3"></iconify-icon></button>
        <button class="action-btn delete" (click)="remove(node)" title="Eliminar"><iconify-icon icon="lucide:trash"></iconify-icon></button>
      </div>
    </div>

    <ul class="tree-branch" *ngIf="node.children?.length">
      <ng-container *ngFor="let child of node.children; trackBy: trackById">
        <ng-container *ngTemplateOutlet="nodeItemTpl; context: {$implicit: child}"></ng-container>
      </ng-container>
    </ul>
  </li>
</ng-template>