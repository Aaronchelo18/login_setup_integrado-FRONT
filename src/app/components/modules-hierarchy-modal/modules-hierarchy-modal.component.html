<div class="mh-modal">
  <div class="mh-head">
    <h3>{{ titulo }}</h3>
    <button class="btn-close" (click)="cerrar()" aria-label="Cerrar">×</button>
  </div>

  <div class="mh-toolbar">
    <button class="btn btn-primary" (click)="addChild()">
      <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 5v14M5 12h14"></path>
      </svg>
      Agregar Módulo Raíz/Hijo
    </button>
  </div>

  <div *ngIf="loading" class="mh-state">Cargando…</div>
  <div *ngIf="!loading && error" class="mh-error">{{ error }}</div>

  <div class="mh-body" *ngIf="!loading && !error">
    <ul class="tree root">
      <ng-container *ngFor="let n of tree; trackBy: trackById">
        <li class="ti">
          <input *ngIf="n.children?.length" class="tgl" type="checkbox" [attr.id]="'t'+n.id_modulo" checked />

          <div class="row">
            <label *ngIf="n.children?.length" class="caret" [attr.for]="'t'+n.id_modulo"></label>
            <span class="node" [class.no-children]="!n.children.length">{{ n.nombre }}</span>

            <div class="actions">
              <button class="tiny add" (click)="addChild(n)" title="Agregar hijo" aria-label="Agregar">
                <svg viewBox="0 0 24 24" width="15" height="15" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M12 5v14M5 12h14"></path>
                </svg>
              </button>

              <button class="tiny edit" (click)="rename(n)" title="Renombrar" aria-label="Renombrar">
                <svg viewBox="0 0 24 24" width="15" height="15" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M12 20h9"></path>
                  <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4z"></path>
                </svg>
              </button>

              <button class="tiny danger" (click)="remove(n)" title="Eliminar" aria-label="Eliminar">
                <svg viewBox="0 0 24 24" width="15" height="15" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
                  <path d="M10 11v6M14 11v6"></path>
                </svg>
              </button>
            </div>
          </div>

          <ul class="branch" *ngIf="n.children?.length">
            <ng-container *ngTemplateOutlet="nodeTpl; context: {$implicit: n.children}"></ng-container>
          </ul>
        </li>
      </ng-container>
    </ul>
  </div>

  <div class="mh-foot">
    <button class="btn" (click)="cerrar()">Cancelar</button>
    <button class="btn btn-primary" (click)="cerrar()">Cerrar</button>
  </div>
</div>

<!-- ======= plantilla recursiva ======= -->
<ng-template #nodeTpl let-list>
  <ng-container *ngFor="let c of list; trackBy: trackById">
    <li class="ti">
      <input *ngIf="c.children?.length" class="tgl" type="checkbox" [attr.id]="'t'+c.id_modulo" checked />

      <div class="row">
        <label *ngIf="c.children?.length" class="caret" [attr.for]="'t'+c.id_modulo"></label>
        <span class="node" [class.no-children]="!c.children?.length">{{ c.nombre }}</span>

        <div class="actions">
          <button class="tiny add" (click)="addChild(c)" title="Agregar hijo" aria-label="Agregar">
            <svg viewBox="0 0 24 24" width="15" height="15" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 5v14M5 12h14"></path>
            </svg>
          </button>

          <button class="tiny edit" (click)="rename(c)" title="Renombrar" aria-label="Renombrar">
            <svg viewBox="0 0 24 24" width="15" height="15" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 20h9"></path>
              <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4z"></path>
            </svg>
          </button>

          <button class="tiny danger" (click)="remove(c)" title="Eliminar" aria-label="Eliminar">
            <svg viewBox="0 0 24 24" width="15" height="15" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
              <path d="M10 11v6M14 11v6"></path>
            </svg>
          </button>
        </div>
      </div>

      <ul class="branch" *ngIf="c.children?.length">
        <ng-container *ngTemplateOutlet="nodeTpl; context: {$implicit: c.children}"></ng-container>
      </ul>
    </li>
  </ng-container>
</ng-template>
